function chainMethods(e,t,a){for(var r in t)a=a[e](t[r]);return a}function getType(e){return Object.prototype.toString.call(e).slice(8,-1)}function isArray(e){return"Array"===getType(e)}function isNull(e){return"Null"===getType(e)}function daysSince(e){var t=Math.abs(new Date-new Date(e));return Math.ceil(t/864e5)}function dayOfWeekAsString(e){return["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][e]}function dayOfWeekAsNumber(e){return 3===e.length?["sun","mon","tue","wed","thu","fri","sat"].indexOf(e.toLowerCase()):["sunday","monday","tuesday","wednesday","thursday","friday","saturday"].indexOf(e.toLowerCase())}function twoDigitMonth(e){return 10>e?"0"+e:e}function twoDigitDate(e){return 10>e?"0"+e:e}function hourlyPeriodicFormula(e){return.5+Math.pow(Math.sin(2*Math.PI*(e/24))+Math.cos(2*Math.PI*(e/24)),3)/5.656}function dailyPeriodicFormula(e){return Math.sin(Math.PI*(e/7))}function createHourlyBidTrainingModelFromReport(e,t,a){for(var r=[],i=e.rows();i.hasNext();){var n=i.next();r.push(createHourlyBidTrainingInstance(n.CampaignName+" - "+n.AdGroupName,dailyPeriodicFormula(dayOfWeekAsNumber(n.DayOfWeek)),hourlyPeriodicFormula(n.HourOfDay),n.AverageCpc))}var o=Prediction.newInsert();o.id=t,o.trainingInstances=r;var s=Prediction.Trainedmodels.insert(o,a);Logger.log(s),Logger.log("Trained model with data.")}function createHourlyBidTrainingInstance(e,t,a,r,i){var n=Prediction.newInsertTrainingInstances();return n.csvInstance=[e+" - "+t,a,r],n.output=i,n}function updateHourlyBidTrainedModelData(e,t,a){for(var r=e.rows();r.hasNext();){var i=r.next(),n=Prediction.newUpdate();n.csvInstance=[i.CampaignName+" - "+i.AdGroupName,dailyPeriodicFormula(dayOfWeekAsNumber(i.DayOfWeek)),hourlyPeriodicFormula(i.HourOfDay)],n.output=i.AverageCpc;var o=Prediction.Trainedmodels.update(n,a,t);Logger.log(o),Logger.log("Trained model updated with new data.")}}function makeHourlyBidPrediction(e,t,a,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:!1,n=new Date,o=AdWordsApp.currentAccount().getTimeZone(),s=Math.filterInt(Utilities.formatDate(n,o,"HH")),d=dayOfWeekAsNumber(Utilities.formatDate(n,o,"E")),u=i?s+1:s;24===u&&(u=0,d+1===7?d=0:d+=1);var g=Prediction.newInput();g.input=Prediction.newInputInput(),g.input.csvInstance=[e+" - "+t,dailyPeriodicFormula(d),hourlyPeriodicFormula(u)];var l=Prediction.Trainedmodels.predict(g,a,r);return l.outputValue}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),repeatableMethods={withIds:"ids",withCondition:"conditions",orderBy:"orderBy"},Iterator=function(){function e(t){classCallCheck(this,e),this.props=t}return createClass(e,[{key:"select",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.props.entity;for(var t in repeatableMethods)e=chainMethods(t,this.props[repeatableMethods[t]],e);return e.forDateRange(this.props.dateRange).withLimit(this.props.limit).get()}},{key:"iterate",value:function(e){for(this.iterator=this.select();this.iterator.hasNext();)e.call(this.iterator.next())}},{key:"toArray",value:function(e){this.iterator=this.build();for(var t=[];this.iterator.hasNext();)if(this.item=this.iterator.next(),e){var a={};for(var r in e)a[r]=e[r].call(this.item);t.push(a)}else t.push(this.item);return t}}]),e}();Math.cbrt||(Math.cbrt=function(e){var t=Math.pow(Math.abs(e),1/3);return 0>e?-t:t}),Math.filterInt||(Math.filterInt=function(e){return/^(\-|\+)?([0-9]+|Infinity)$/.test(e)?Number(e):NaN});var firstRun=!0,runsLate=!1,dateRange="ALL_TIME",daysRunning=daysSince("March 1, 2017"),maxBid=25,maxDisplayBid=3,modelName="oroville-cardio",projectId="168438661239",accountStartDate="20170301",spreadsheetUrl="https://docs.google.com/spreadsheets/d/1sh41PAf4K7GhkX4CPuxUx8DQWzy4Rvw366KaF1LMmz8/edit#gid=896040189",config=["keywords",["display","audiences"],["display","keywords"],["display","topics"]],ortb=function(e,t,a,r){var i=Math.cbrt(t*Math.pow(a,2)/r);return 2*e*i},getRowByName=function(e,t){var a=e.getRange(1,1,e.getMaxRows()),r=a.getValues(),i=-1;for(var n in r)r[n][0]===t&&(i=Math.filterInt(n)+1);return i},main=function(){var e=new Date,t=AdWordsApp.currentAccount().getTimeZone(),a=Utilities.formatDate(e,t,"HH"),r=dayOfWeekAsNumber(Utilities.formatDate(e,t,"E")),i=""+e.getFullYear()+twoDigitMonth(e.getMonth()+1)+twoDigitDate(e.getDate());if(Logger.log(("undefined"==typeof a?"undefined":_typeof(a))+" - "+dayOfWeekAsString(r)),firstRun===!0){var n=AdWordsApp.report("SELECT CampaignName,AdGroupName,DayOfWeek,HourOfDay,AverageCpc  FROM ADGROUP_PERFORMANCE_REPORT  WHERE Clicks > 0  DURING "+(accountStartDate+","+i));createHourlyBidTrainingModelFromReport(n,modelName,projectId)}else!function(){var e=Math.filterInt(a);24===e&&(e=0,r+1===7?r=0:r+=1),Logger.log(dayOfWeekAsString(r));var t=SpreadsheetApp.openByUrl(spreadsheetUrl),i=t.getSheetByName(dayOfWeekAsString(r));if(new Iterator({entity:AdWordsApp.adGroups(),conditions:["CampaignStatus = ENABLED","Status = ENABLED","Clicks > 0"],dateRange:dateRange}).iterate(function(){var t=this.getCampaign(),a=makeHourlyBidPrediction(t.getName(),this.getName(),projectId,modelName,runsLate),r=a;Logger.log(t.getName()+" - "+this.getName()+" - "+r+" - "+this.bidding().getCpc()),maxBid>r?this.bidding().setCpc(r):this.bidding().setCpc(maxBid);for(var n in config)try{for(var o=isArray(config[n])?this[config[n][0]]()[config[n][1]]().get():this[config[n]]().get();o.hasNext();){var s=o.next();s.bidding().clearCpc();var d=s.getStatsFor("LAST_30_DAYS"),u=null===d.getAveragePosition()?1:d.getAveragePosition();if(u*=1+d.getConversionRate(),"Keyword"===s.getEntityType()&&"display"!==config[n][0]){var g=s.getQualityScore();isNull(g)||(u*=1+g/40)}var l=this.bidding().getCpc(),c=d.getCtr(),f=u/(l*c),p=d.getClicks()/daysRunning,y=t.getBudget(),m=ortb(c,y,f,p),h=t.getName()+" - "+this.getName()+" - "+s.getId(),v=getRowByName(i,h);-1===v&&(v=i.getMaxRows()+1);var N=2,A=i.getRange("A"+v);try{var C=s.getFirstPageCpc();isNaN(m)?C>r&&maxBid>C?(Logger.log("First Page Cpc Bid - "+C+" ("+r+")"),s.bidding().setCpc(C)):C>r&&C>maxBid&&(Logger.log("Max Bid - "+maxBid+" ("+r+")"),s.bidding().setCpc(maxBid)):C>m&&maxBid>C?(Logger.log("First Page Cpc Bid - "+C+" ("+m+")"),s.bidding().setCpc(C)):C>m&&C>maxBid?(Logger.log("Max Bid - "+maxBid+" (FPCPC: "+C+", Bid: "+m+")"),s.bidding().setCpc(maxBid)):maxBid>m?(Logger.log("Predicted Bid - "+m),s.bidding().setCpc(m),A.setValue(h),A=i.getRange(v,e+N),A.setValue(m)):Logger.log("No Match")}catch(M){!isNaN(m)&&maxDisplayBid>m?(s.bidding().setCpc(m),Logger.log("Predicted Bid - "+m),A.setValue(h),A=i.getRange(v,e+N),A.setValue(m)):!isNaN(m)&&m>maxDisplayBid?(s.bidding().setCpc(maxDisplayBid),Logger.log("Max Bid - "+maxDisplayBid+" ("+m+")")):Logger.log("No Match")}}}catch(M){Logger.log(M)}}),"04"===a){var n=AdWordsApp.report("SELECT CampaignName,AdGroupName,DayOfWeek,HourOfDay,AverageCpc  FROM ADGROUP_PERFORMANCE_REPORT  WHERE Clicks > 0 DURING YESTERDAY");updateHourlyBidTrainedModelData(n,modelName,projectId)}}()};main();